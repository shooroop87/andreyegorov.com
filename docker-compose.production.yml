volumes:
  static_volume:
  media:
  sqlite_data:

services:
  backend:
    image: egorovdocker/andreyegorov_backend
    env_file: .env
    environment:
      - DOCKER_ENV=true
    volumes:
      - static_volume:/app/collected_static
      - media:/app/media/
      - sqlite_data:/app/data/
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; socket.create_connection((\"localhost\", 8000), timeout=2)' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    command: >
      sh -c "
        mkdir -p /app/data &&
        python manage.py migrate --noinput &&
        python manage.py collectstatic --clear --noinput --verbosity=1 &&
        gunicorn backend.wsgi:application --bind 0.0.0.0:8000 --access-logfile - --error-logfile - --log-level info
      "
    restart: unless-stopped

  gateway:
    image: egorovdocker/andreyegorov_gateway
    env_file: .env
    volumes:
      - static_volume:/staticfiles:ro
      - media:/mediafiles:ro
    ports:
      - "8000:80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped